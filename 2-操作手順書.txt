================================================================================
                    割付・板取 PoC — 操作手順書
================================================================================
  機能解説・操作手順・処理ロジックを分かりやすくまとめたガイドです。
================================================================================

■ 目次
  第1部  機能解説（何ができるか）
  第2部  操作手順（画面ごとの使い方）
  第3部  処理ロジック（システムがどのように計算するか）


================================================================================
第1部  機能解説（何ができるか）
================================================================================

--------------------------------------------------------------------------------
1.1 システムでできること（全体像）
--------------------------------------------------------------------------------

このPOCは、次の3つの機能で構成されています。

  (1) 入力
      ・部屋の形と扉・窓の位置を「案件」として読み込む
      ・デモ案件（最初から入っているサンプル）か、CEDXMファイルのどちらか

  (2) 割付（わりつけ）
      ・各壁に、石膏ボードをどの位置に何枚はるかを自動計算する
      ・間柱の間隔（455mm または 303mm）や、角の「勝ち負け」ルールに従う
      ・扉・窓の部分は板を置かず、開口として扱う

  (3) 板取（いたどり）
      ・割付で出た板のサイズを、原板（910×2430mm など）の上にどう並べるか計算する
      ・無駄を減らす（歩留まりを上げる）ように配置する

  その結果を、画面で確認したり、CSVでダウンロードして現場や積算に使えます。


--------------------------------------------------------------------------------
1.2 画面の構成（どこに何があるか）
--------------------------------------------------------------------------------

  【上部】
    ・タイトル：「割付・板取 PoC」
    ・キャプション：対象（四角部屋＋扉・窓）と多言語対応の説明

  【左：サイドバー】
    ・言語選択       … 日本語 / English / 中文 / Tiếng Việt
    ・CEDXMファイル読み込み … 案件をファイルから読み替える
    ・板サイズ選択   … 3×8 / 3×9 / 3×10 のいずれか
    ・「▶ 割付・板取を実行」ボタン … ここを押すと計算が走る

  【中央：タブ】
    タブは6つあります。

    1. 案件ビュー    … 案件の情報・平面図・3D図・壁の編集
    2. 割付ビュー    … 壁ごとの割付結果（立面図）・間柱・再計算
    3. 板取ビュー    … 原板の上に板がどう並んだか
    4. 図面・帳票ビュー … 部材表・板取結果・エラー一覧の表とCSV
    5. マスター内容  … 現在の板サイズ・規格などの設定値（参照用）
    6. 設定          … 板サイズ・規格・板取ルールを変更する

  【下部】
    ・フッター：PoC図面や機能の説明


--------------------------------------------------------------------------------
1.3 各機能の説明
--------------------------------------------------------------------------------

  ■ 言語選択
    ・画面の表示言語を切り替えます。
    ・日本語・英語・中国語・ベトナム語に対応しています。
    ・切り替えると画面がすぐに再読み込みされ、選択した言語で表示されます。

  ■ CEDXMファイル読み込み
    ・部屋の形や扉・窓を定義したXML形式（.cedxm または .xml）をアップロードします。
    ・読み込むと、案件がその内容に差し替わり、壁の高さに合わせて板サイズが自動選択されます。
    ・サンプルとして sample1.cedxm / sample2.cedxm が同梱されています。

  ■ 板サイズ選択（サイドバー）
    ・使用する石膏ボードの規格を選びます。
      3×8 … 910×2430mm（標準）
      3×9 … 910×2730mm（高天井向け）
      3×10 … 910×3030mm（特殊）
    ・選んだサイズは、次に「割付・板取を実行」したときから反映されます。

  ■ 割付・板取を実行
    ・現在の案件・板サイズ・規格に基づいて、割付と板取を一括計算します。
    ・実行後、案件ビュー・割付ビュー・板取ビュー・図面・帳票ビューに結果が表示されます。
    ・最初に画面を開いただけでは結果は出ません。案件を読込後、このボタンを押してください。

  ■ 1. 案件ビュー
    ・案件情報：案件ID・名前・部屋ID・用途・階・壁高さ
    ・開口一覧：扉・窓のID・壁・種類・幅・高さ・窓台高さ・オフセット
    ・壁情報：出隅ルール適用後の壁長さなど（実行後に表示）
    ・KPIサマリ：歩留まり（推定）・ボード枚数・エラー数（実行後に表示）
    ・平面図：部屋の形と壁・間柱などを2Dで表示（Plotly・ドラッグで移動・ズーム可能）
    ・壁編集モード：トグルONで「壁を描く」「部屋を描く」が使え、新規壁を追加できる
    ・3D見付図：部屋を3Dで見たときの壁面の様子（実行後に表示）

  ■ 2. 割付ビュー
    ・壁ごとにタブ（W1, W2, W3, W4 と、追加した壁は W5, W6…）が並びます。
    ・各タブで、その壁の立面図と、どこにどの板が載るかが色分けして表示されます。
      緑 … 真物、青 … 端材・セミ等、赤 … 開口部
    ・間柱ピッチを 455mm / 303mm で変更して「再計算」すると、そのピッチで割付し直します。
    ・「最小片の一括自動修正」は、最小片より小さいパネルに備考フラグを付ける試作機能です。

  ■ 3. 板取ビュー
    ・原板（910×2430mm 等）の上に、パネルがどう並んだかを図で表示します。
    ・推定利用率（歩留まり）がパーセントで表示されます。

  ■ 4. 図面・帳票ビュー
    ・部材表（割付）：壁・位置・寸法・切欠要否・端材フラグ・備考
    ・ボード配置（板取）：シート番号・x,y・幅・高さ・回転の有無
    ・エラー一覧：情報・警告・エラーコード
    ・各表の下のボタンから、CSVをダウンロードできます（UTF-8 BOM付き・Excelで開きやすい）。

  ■ 5. マスター内容
    ・現在の「板」「規格」「出力形態」をJSON形式で確認できます。変更は「6. 設定」で行います。

  ■ 6. 設定
    ・板サイズ選択・回転を許可するか・出力形態（真物/セミ/フル）
    ・規格・ルール：最小片(mm)・クリアランス(mm)・刃厚(mm)・ジョイント幅(mm)
    ・板取ルール：機械加工（歩留り優先）か、手加工（長手優先）か
    ・変更後は「▶ 割付・板取を実行」で再計算すると反映されます。


--------------------------------------------------------------------------------
1.4 壁編集モード（新規壁の追加）
--------------------------------------------------------------------------------

  「1. 案件ビュー」→「平面図」タブで「🖊️ 壁編集モード」をONにすると使えます。

  ・壁を描く
    始点と終点を指定して1本の壁を作成します。水平・垂直方向に自動補正されます。

  ・部屋を描く
    矩形のエリアを2点（例：左下と右上）で指定すると、4辺の壁がまとめて作成されます。

  ・作成した壁は「新規壁を割付・板取に反映」ボタンで確定すると、
    次回の「割付・板取を実行」から W5, W6 … として割付・板取の対象になります。
    内壁は片側面のみ割付です。両面施工の場合は同一壁を2回割付する運用で対応できます。


================================================================================
第2部  操作手順（画面ごとの使い方）
================================================================================

--------------------------------------------------------------------------------
2.1 起動から最初の結果を見るまで（最短手順）
--------------------------------------------------------------------------------

  ステップ1  アプリを開く
    ・ブラウザで指定のURLを開く

  ステップ2  言語を選ぶ（任意）
    ・サイドバー上部の言語のドロップダウンで「日本語」などを選択
    ・画面がその言語で切り替わります

  ステップ3  案件を確認する
    ・最初は「デモ案件」が読み込まれた状態です。
    ・「1. 案件ビュー」タブを開き、「案件情報」で部屋・開口を確認できます。
    ・別の案件にしたい場合は、サイドバーでCEDXMファイルをアップロードします。

  ステップ4  板サイズを確認・変更する（任意）
    ・サイドバーの「板サイズ選択」で 3×8 / 3×9 / 3×10 のいずれかを選択
    ・CEDXMを読み込んだ場合は、壁の高さに応じて自動選択されていることがあります

  ステップ5  割付・板取を実行する
    ・サイドバーの「▶ 割付・板取を実行」ボタンをクリック
    ・「建築的制約に基づく割付・板取を実行しました」のようなメッセージが出れば成功

  ステップ6  結果を確認する
    ・「1. 案件ビュー」… KPIサマリ・平面図・3D見付図
    ・「2. 割付ビュー」… 各壁の立面と割付
    ・「3. 板取ビュー」… 原板レイアウトと利用率
    ・「4. 図面・帳票ビュー」… 部材表・板取CSV・エラーCSVのダウンロード


--------------------------------------------------------------------------------
2.2 CEDXMファイルで案件を読み込む手順
--------------------------------------------------------------------------------

  ステップ1  サイドバーの「CEDXMファイル読み込み」の下にあるファイル選択をクリック

  ステップ2  .cedxm または .xml のファイルを1つ選ぶ

  ステップ3  読み込みが成功すると「CEDXMを読み込みました。壁高さに応じて石膏ボードを選択しました。」と表示される
    ・案件が差し替わり、板サイズが壁高さに合わせて自動選択されます
    ・エラーが出た場合は、XMLの形式（Room / Polygon / Openings など）を確認してください

  ステップ4  「▶ 割付・板取を実行」を押して、新しい案件で結果を計算する


--------------------------------------------------------------------------------
2.3 板サイズ・規格を変えてやり直す手順
--------------------------------------------------------------------------------

  ステップ1  「6. 設定」タブを開く

  ステップ2  左カラムで板サイズ・回転許可・出力形態を、右カラムで規格（最小片・クリアランス・刃厚・ジョイント）や板取ルールを変更する

  ステップ3  サイドバーに戻り、「▶ 割付・板取を実行」をクリックする
    ・設定を変えただけでは結果は更新されません。必ず実行ボタンを押してください。

  ステップ4  割付ビュー・板取ビュー・図面・帳票ビューで結果を確認する


--------------------------------------------------------------------------------
2.4 間柱ピッチを変えて割付だけやり直す手順（割付ビュー内）
--------------------------------------------------------------------------------

  ステップ1  「2. 割付ビュー」タブを開く

  ステップ2  「間柱設定」の見出しの下で「間柱ピッチ」のドロップダウンを 455mm または 303mm に変更する

  ステップ3  「🔄 間柱ピッチを変更して再計算」ボタンをクリックする
    ・割付と板取が、選択したピッチで再計算され、画面が更新されます。


--------------------------------------------------------------------------------
2.5 壁を追加して割付・板取に含める手順（壁編集モード）
--------------------------------------------------------------------------------

  ステップ1  「1. 案件ビュー」→「平面図」タブを開く

  ステップ2  「🖊️ 壁編集モード」のトグルをONにする

  ステップ3  壁を1本だけ追加する場合
    ・「🖱️ 壁を描く」をクリック
    ・始点の座標（X, Y）を入力して「➕ 点を追加」
    ・終点の座標を入力して「➕ 点を追加」
    ・「✅ 壁を作成」をクリック
    ・水平・垂直に自動補正されます

  ステップ3'  矩形の部屋として複数壁を追加する場合
    ・「🔲 部屋を描く」をクリック
    ・左下の点の座標を入力→「➕ 点を追加」
    ・右上の点の座標を入力→「➕ 点を追加」
    ・「✅ 部屋を作成」をクリック

  ステップ4  「新規壁を割付・板取に反映」ボタンをクリックする
    ・追加した壁が割付対象に登録され、画面が更新されます


--------------------------------------------------------------------------------
2.6 部材表・板取結果・エラーをCSVでダウンロードする手順
--------------------------------------------------------------------------------

  ステップ1  「4. 図面・帳票ビュー」タブを開く

  ステップ2  部材表（割付）の表の下の「部材表CSVをダウンロード」をクリック → panels.csv がダウンロードされる

  ステップ3  ボード配置（板取）の表の下の「板取結果CSVをダウンロード」をクリック → nesting.csv がダウンロードされる

  ステップ4  エラー一覧の表の下の「エラーCSVをダウンロード」をクリック → errors.csv がダウンロードされる

  ・いずれも UTF-8 BOM 付きのため、Excel で開いても文字化けしにくい形式です。


--------------------------------------------------------------------------------
2.7 図面の見方（平面図・3D・壁立面・板取図）
--------------------------------------------------------------------------------

  ・ドラッグ … 図の位置を移動できます
  ・スクロールホイール（またはピンチ） … ズームイン・アウト
  ・ホバー（マウスを乗せる） … 要素によっては詳細情報が表示されます
  ・凡例や色の説明は、各タブ内の「色：緑=真物」などの説明を参照してください


================================================================================
第3部  処理ロジック（システムがどのように計算するか）
================================================================================

--------------------------------------------------------------------------------
3.1 全体の流れ（実行ボタンを押したあと）
--------------------------------------------------------------------------------

  「▶ 割付・板取を実行」を押すと、次の順で処理が進みます。

  (1) 構造要素の生成
      ・部屋の形（多角形）と間柱ピッチ（455mm または 303mm）から、
        通り芯・柱・梁・間柱（キングスタッド含む）を生成します。
      ・これが「どこに間柱が立つか」の基準になります。

  (2) 割付（パネル配置の計算）
      ・各壁について：
        ア) 出隅の勝ち負けルールで、壁の「有効な長さ」を決めます。
        イ) 間柱の位置（グリッド）をピッチに沿って生成します。
        ウ) 扉・窓の範囲ではパネルを置かず、開口として扱います（クリッピング）。
        エ) 壁の長さと高さの範囲に、板サイズとルールに従ってパネルを並べます。
      ・外周壁 W1～W4 に加え、壁編集で追加した壁（W5, W6…）も同じように計算します。

  (3) 板取（原板への配置の計算）
      ・割付で得られたパネル（寸法のリスト）を、原板（例：910×2430mm）の上に載せます。
      ・「棚（Shelf）法」という方式で、大きいパネルから順に並べ、無駄を減らします。
      ・回転して載せられるかは、「回転を許可する」「歩留り優先/長手優先」の設定に依存します。

  (4) 結果の保存と表示
      ・計算した「パネル一覧」「エラー・情報」「板取配置」「利用率」「枚数」が保存され、
        案件ビュー・割付ビュー・板取ビュー・図面・帳票ビューに反映されます。


--------------------------------------------------------------------------------
3.2 出隅の「勝ち負け」ルール（割付でなぜ壁の長さが変わるか）
--------------------------------------------------------------------------------

  部屋の角では、2つの壁が接しています。どちらの壁を「通し」にして、
  どちらを「壁厚ぶん短くするか」を決めるルールが「勝ち負け」です。

  ・時計回りに W1 → W2 → W3 → W4 → W1 の順で「勝ち」側が通し、隣は短くなります。
  ・こうすることで、角で板が二重に数えられず、施工に近い寸法で割付できます。
  ・システム内部で自動的に適用されるため、ユーザーが指定する必要はありません。


--------------------------------------------------------------------------------
3.3 間柱グリッド（455mm / 303mm）
--------------------------------------------------------------------------------

  ・石膏ボードは、間柱に沿って取り付けます。
  ・間柱の間隔を「間柱ピッチ」といい、本システムでは 455mm または 303mm を選べます。
  ・壁の始点から、このピッチで間柱位置が並び、その位置に合わせてパネルの端が来るように割付されます。
  ・割付ビューで「間柱ピッチを変更して再計算」を行うと、選んだピッチで割付がやり直されます。


--------------------------------------------------------------------------------
3.4 開口部（扉・窓）の扱い
--------------------------------------------------------------------------------

  ・扉・窓が定義されている範囲では、パネルは配置されません（開口としてクリップされます）。
  ・割付ビューでは開口部が暗い赤で表示されます。
  ・開口の位置は、CEDXM やデモ案件の「offset」や「center」で指定された通りに計算されます。


--------------------------------------------------------------------------------
3.5 板取（棚法）の考え方
--------------------------------------------------------------------------------

  ・割付で出た「パネル」は、幅・高さのリストです。これらを原板（910×2430mm 等）に載せます。
  ・「棚法」では、原板を下から上に「棚」のように使い、パネルを大きい順に並べていきます。
  ・同じ原板に載らなくなったら次の原板に移り、必要な枚数と全体の利用率が計算されます。
  ・「回転を許可する」がONのときは、パネルを90度回転して載せることもあります（歩留り優先）。
  ・「長手優先」を選ぶと、回転をなるべく使わない方向で配置します（手加工想定）。


--------------------------------------------------------------------------------
3.6 エラー・情報メッセージ
--------------------------------------------------------------------------------

  ・割付・板取の過程で、情報（INFO）・警告・エラー（E- で始まるコードなど）が記録されます。
  ・「4. 図面・帳票ビュー」のエラー一覧と、そのCSVで内容を確認できます。
  ・「1. 案件ビュー」のKPIサマリには、エラー数（E- で始まるものの個数）が表示されます。


================================================================================
                          以上で操作手順書は終わりです
================================================================================
  詳細なシステム仕様は 1-README.mdを参照してください。
================================================================================
