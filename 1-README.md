# 石膏ボード割付・板取最適化システム

建築現場における石膏ボードの割付と板取を自動化するPoC（概念実証）システムです。建築的制約を考慮した正確な割付計算と、効率的な板取最適化を実現します。

## 🏗️ システム概要

このシステムは、四角形の部屋に対して石膏ボードの割付と板取を自動計算します：

- **割付機能**: 間柱グリッド、出隅の勝ち負けルール、開口部クリッピングを考慮
- **板取機能**: FFDH（First Fit Decreasing Height）アルゴリズムによる効率的な配置
- **可視化機能**: Plotlyを使用したインタラクティブなCAD図面表示
- **3D表示**: 立体的な見付図による直感的な理解

## 📋 主な機能

### 1. 建築的制約に基づく割付
- **間柱グリッド**: 455mm/303mmピッチでの正確な配置
- **出隅ルール**: W1→W2→W3→W4の時計回り勝ち負けルール
- **開口部処理**: 扉・窓による矩形分割とクリッピング
- **端材判定**: 規格サイズより小さいパーツの自動識別

### 2. 板取最適化
- **棚詰め法**: 面積降順ソートによる効率的配置
- **回転制御**: 歩留り優先/長手優先の選択可能
- **利用率計算**: リアルタイムでの歩留まり表示

### 3. インタラクティブ可視化
- **平面プレビュー**: パネル配置を含む詳細平面図
- **3D見付図**: 立体的な壁面とパネル表示
- **壁立面図**: 各壁の詳細割付状況
- **板取図**: 複数シートの配置結果

## 🚀 セットアップ手順

### 前提条件
- Windows 10/11
- Python 3.8以上
- pip（Pythonパッケージマネージャー）

### 1. ファイルの準備
プロジェクトファイルを任意のフォルダに配置してください：
```
project-folder/
├── app.py
├── requirements.txt
├── run_app.bat
└── src/
    ├── __init__.py
    ├── masterdata.py
    ├── input.py
    ├── logic.py
    ├── allocating.py
    ├── nesting.py
    ├── visualization.py
    └── output.py
```

### 2. 自動セットアップ（推奨）
1. `run_app.bat` をダブルクリック
2. 必要なライブラリが自動的にインストールされます
3. Streamlitアプリが起動します

### 3. 手動セットアップ
コマンドプロンプトまたはPowerShellで以下を実行：

```bash
# 依存関係のインストール
pip install -r requirements.txt

# アプリケーションの起動
streamlit run app.py
```

### 4. ブラウザでアクセス
- 自動的にブラウザが開きます
- 手動の場合: http://localhost:8501 にアクセス

## 📖 使い方ガイド

### 基本操作手順

#### 1. 初期設定
![サイドバー設定](docs/sidebar.png)

**サイドバーで以下を設定：**

1. **間柱ピッチ設定**
   - `455mm`（標準）または `303mm` を選択
   - 建築基準に応じて選択してください

2. **板サイズ選択**
   - `3×8 (910×2430mm)` - デフォルト
   - `3×9 (910×2730mm)` - 高天井用
   - `3×10 (910×3030mm)` - 特殊用途

3. **規格・ルール**
   - **最小片**: 150mm（デフォルト）
   - **クリアランス**: 5mm
   - **刃厚**: 3mm
   - **ジョイント幅**: 3mm

4. **出力形態**
   - **真物**: 切欠なしパネルのみ
   - **セミ**: 切欠ありパネル含む（デフォルト）
   - **フル**: 開口部で完全分割

#### 2. 計算実行
1. サイドバー下部の「▶ 割付・板取を実行」ボタンをクリック
2. 計算が完了すると成功メッセージが表示されます
3. 各タブで結果を確認できます

#### 3. 結果の確認

##### タブ1: 案件ビュー
- **案件情報**: プロジェクトの基本データ
- **KPIサマリ**: 歩留まり、原板枚数、エラー数
- **平面プレビュー**: インタラクティブな平面図
  - ズーム・パン操作可能
  - ホバーで詳細情報表示
  - パネル配置を色分け表示（青=真物、赤=端材）
- **3D表示見付図**: 立体的な壁面表示
  - マウスで回転・ズーム可能
  - 壁厚さと出隅ルールを正確に表現

##### タブ2: 割付ビュー
- **壁立面図**: 各壁（W1〜W4）の詳細割付
  - パネル寸法と配置位置
  - 開口部との関係
  - 端材・切欠の識別
- **間柱設定**: ピッチ変更と再計算
- **自動修正**: 最小片違反の一括処理

##### タブ3: 板取ビュー
- **板取結果**: 複数シートの配置図
- **利用率表示**: 材料効率の確認
- **パネル番号**: 各パーツの識別

##### タブ4: 図面・帳票ビュー
- **部材表**: パネル一覧（CSV出力可能）
- **原板配置**: 板取結果（CSV出力可能）
- **エラー一覧**: 問題点の詳細（CSV出力可能）

##### タブ5: マスター内容
- **設定確認**: 現在の計算パラメータ
- **JSON形式**: 設定値の詳細表示

### 高度な操作

#### 間柱ピッチの変更
1. タブ2「割付ビュー」を開く
2. 「間柱設定」で新しいピッチを選択
3. 「🔄 間柱ピッチを変更して再計算」をクリック
4. 結果が自動更新されます

#### 最小片の自動修正
1. タブ2「割付ビュー」を開く
2. 「🛠 最小片の一括自動修正」をクリック
3. 違反パネルに備考が追加されます

#### データのエクスポート
1. タブ4「図面・帳票ビュー」を開く
2. 各テーブル下の「CSVをダウンロード」ボタンをクリック
3. Excel等で開いて詳細分析が可能

## 🔧 技術仕様

### システム構成
```
app.py                    # メインUI（Streamlit）
├── src/masterdata.py     # データモデル定義
├── src/input.py          # 入力データ処理
├── src/logic.py          # 基本ロジック
├── src/allocating.py     # 割付アルゴリズム
├── src/nesting.py        # 板取アルゴリズム
├── src/visualization.py  # Plotly可視化
└── src/output.py         # 出力処理
```

### 割付アルゴリズム詳細

#### 1. 間柱グリッド生成
```python
# 455mmピッチの例
positions = [0, 455, 910, 1365, 1820, ...]
```
- 壁の左端から開始
- 指定ピッチで間柱位置を計算
- 壁の右端を必ず含む

#### 2. 出隅の勝ち負けルール
```
W1（下壁）→ W2（右壁）→ W3（上壁）→ W4（左壁）
```
- 時計回りに勝ち負けを決定
- 勝ち側は通し、負け側は壁厚分短縮
- 建築的に正しい施工順序を反映

#### 3. 開口部クリッピング
- 矩形分割アルゴリズム
- 4方向（左・右・上・下）への分割
- 面積10mm²未満の微小片は除去

### 板取アルゴリズム詳細

#### FFDH（First Fit Decreasing Height）法
1. **ソート**: パネルを面積降順で並び替え
2. **棚作成**: 水平方向に配置スペースを確保
3. **配置判定**: 現在の棚に収まるかチェック
4. **新棚作成**: 収まらない場合は上段に新しい棚
5. **新シート**: 板の高さを超える場合は新しい原板

#### 利用率計算
```
利用率 = (全パネル面積の合計) ÷ (使用原板の総面積) × 100
```

## 📊 出力データ形式

### 部材表（panels.csv）
| 項目 | 説明 |
|------|------|
| part_no | パーツ番号（P0001〜） |
| wall | 壁ID（W1〜W4） |
| x0, y0 | 壁上の配置位置（mm） |
| w, h | パネル寸法（mm） |
| requires_cutout | 切欠の要否 |
| is_cut_piece | 端材判定 |
| note | 備考 |

### 板取結果（nesting.csv）
| 項目 | 説明 |
|------|------|
| sheet_id | シート番号 |
| x, y | 原板上の配置位置（mm） |
| w, h | パネル寸法（mm） |
| rotated | 回転の有無 |
| panel_ref | 元パネル情報 |

## ⚠️ 制限事項

### 現在の制約
- **部屋形状**: 四角形のみ対応
- **開口種類**: 扉・窓の矩形開口のみ
- **板形状**: 矩形板のみ（切欠形状は未対応）
- **壁構造**: 単純な直交壁のみ

### 将来の拡張予定
- 複雑な部屋形状への対応
- L字型・T字型開口の処理
- 切欠・角落とし形状の板取
- 複数部屋の一括処理
- 材料コスト計算機能

## 🐛 トラブルシューティング

### よくある問題

#### 1. アプリが起動しない
**症状**: `run_app.bat`をクリックしても何も起こらない
**解決策**:
```bash
# コマンドプロンプトで手動実行
cd プロジェクトフォルダ
pip install -r requirements.txt
streamlit run app.py
```

#### 2. ライブラリエラー
**症状**: `ModuleNotFoundError: No module named 'plotly'`
**解決策**:
```bash
pip install plotly streamlit pandas numpy matplotlib
```

#### 3. 文字化け
**症状**: 日本語が□で表示される
**解決策**:
- Windows設定で日本語フォントを確認
- ブラウザの文字エンコーディングをUTF-8に設定

#### 4. 計算エラー
**症状**: 「最小片違反」エラーが多発
**解決策**:
- 最小片サイズを小さく設定（100mm以下）
- 間柱ピッチを303mmに変更
- 板サイズを大きいものに変更

#### 5. 3D表示が重い
**症状**: 3D見付図の動作が遅い
**解決策**:
- ブラウザのハードウェアアクセラレーションを有効化
- 他のタブを閉じてメモリを確保
- パネル数を減らす（部屋サイズを小さく）

### エラーコード一覧

| コード | 説明 | 対処法 |
|--------|------|--------|
| E-004 | 最小片違反 | 最小片サイズを調整 |
| WARN-HEIGHT-MATCH | 板高さ不一致 | 適切な板サイズを選択 |
| INFO-TIME | 処理時間情報 | 参考情報（対処不要） |


## 📝 更新履歴

### v1.0.0 (2026-02-04)
- 初回リリース
- 基本的な割付・板取機能
- Plotly可視化対応
- 3D表示見付図実装


